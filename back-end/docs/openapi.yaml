openapi: 3.0.0
info:
  title: UnderSounds API Authentication
  version: "1.0.0"
  description: "API for user management: registration, login, update, logout, OAuth2.0 with Google, password recovery, and refresh token via cookies."
servers:
  - url: "{protocol}://{host}/api"
    variables:
      protocol:
        default: "http"
        enum:
          - "http"
          - "https"
      host:
        default: "192.168.1.70:5000"
paths:
  /auth/register:
    post:
      summary: Register a new account.
      requestBody:
        description: User data for account creation.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: fanUser1
                email:
                  type: string
                  example: fan1@example.com
                password:
                  type: string
                  example: password123
              required:
                - username
                - email
                - password
      responses:
        "201":
          description: Account created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        "500":
          description: Internal error.
  /auth/login:
    post:
      summary: Log in.
      requestBody:
        description: Credentials to access.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: fan1@example.com
                password:
                  type: string
                  example: password123
              required:
                - email
                - password
      responses:
        "200":
          description: Successful login. Returns the access token in the body and sets the refresh token in an HttpOnly cookie.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        "401":
          description: Invalid credentials.
  /auth/refresh-token:
    post:
      summary: Refresh the access token using the refresh token stored in a cookie.
      responses:
        "200":
          description: New access token generated.
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    example: newAccessToken123
        "401":
          description: Invalid or expired refresh token.
  /auth/{id}:
    put:
      summary: Update user profile.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        description: Fields to update.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: newName
                bio:
                  type: string
                  example: New bio
                bandName:
                  type: string
                  example: The Rockers
                genre:
                  type: string
                  example: Rock
                labelName:
                  type: string
                  example: Super Records
                website:
                  type: string
                  example: https://example.com
      responses:
        "200":
          description: Updated account.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        "500":
          description: Internal error.
  /auth/logout:
    post:
      summary: Log out the user.
      responses:
        "200":
          description: Successful logout. The access token in memory is deleted and the refresh token cookie is removed.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
  /auth/forgot-password:
    post:
      summary: Request password recovery.
      requestBody:
        description: User email to send the OTP code.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: fan1@example.com
      responses:
        "200":
          description: Confirmation message (the code is sent if the account exists).
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type:    string
                    example: "If the email exists, a recovery code will be sent"
        "500":
          description: Internal error.
  /auth/reset-password:
    post:
      summary: Reset the password using the OTP code.
      requestBody:
        description: Email, OTP code and new password.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: fan1@example.com
                otp:
                  type: string
                  example: "AbC123"
                newPassword:
                  type: string
                  example: newPassword123
      responses:
        "200":
          description: Password updated successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        "400":
          description: OTP code invalid or expired.
        "500":
          description: Internal error.
  /auth/google:
    get:
      summary: Start authentication with Google.
      responses:
        "302":
          description: Redirects to Google for authentication.
  /auth/google/callback:
    get:
      summary: Google authentication callback.
      responses:
        "302":
          description: Redirects to the frontend after successful authentication.
  /albums:
    get:
      summary: Get all albums.
      responses:
        "200":
          description: Album list retrieved successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Album'
        "500":
          description: Server internal error.
    post:
      summary: Creates new album.
      requestBody:
        description: Data for creating an album.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlbumInput'
      responses:
        "201":
          description: Album created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Album'
        "400":
          description: Invalid data.
        "500":
          description: Server internal error.
  /albums/{id}:
    get:
      summary: Get an album by its ID.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Album obtained successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Album'
        "404":
          description: Album not found.
        "500":
          description: Server internal error.
    put:
      summary: Updates an existing album.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        description: Album data updated.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlbumInput'
      responses:
        "200":
          description: Album updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Album'
        "404":
          description: Album not found.
        "500":
          description: Server internal error.
    delete:
      summary: Deletes an album.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Album deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Album deleted successfully"
        "404":
          description: Album not found.
        "500":
          description: Server internal error.
  /albums/{id}/ratings:
    post:
      summary: Adds a rating to an album.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        description: Rating data.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId:
                  type: string
                  example: "60d0fe4f5311236168a109ca"
                rating:
                  type: number
                  example: 4.5
                comment:
                  type: string
                  example: "Gran álbum, excelentes pistas"
                profileImage:
                  type: string
                  example: "/assets/images/avatar1.jpg"
      responses:
        "200":
          description: Rating added successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  album:
                    $ref: '#/components/schemas/Album'
        "404":
          description: Album not found.
        "500":
          description: Server internal error.
  /albums/{id}/download:
    get:
      summary: Downloads a specific track from an album.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: query
          name: trackId
          required: true
          schema:
            type: string
          description: ID of the track to download.
        - in: query
          name: format
          required: false
          schema:
            type: string
            enum: [mp3, wav, flac]
            default: mp3
          description: Audio format for the download.
      responses:
        "200":
          description: Audio file downloaded successfully.
          content:
            audio/mpeg:
              schema:
                type: string
                format: binary
            audio/wav:
              schema:
                type: string
                format: binary
            audio/flac:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid parameters.
        "404":
          description: Album or track not found.
        "500":
          description: Server internal error.
  /albums/{id}/download-album:
    get:
      summary: Download a complete album as a ZIP file.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: query
          name: format
          required: false
          schema:
            type: string
            enum: [mp3, wav, flac]
            default: mp3
          description: Audio format for the album tracks.
      responses:
        "200":
          description: ZIP file downloaded successfully.
          content:
            application/zip:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid parameters.
        "404":
          description: Album not found or without tracks.
        "500":
          description: Server internal error.
  /artists:
    get:
      summary: Get all artist
      responses:
        "200":
          description: Artits list obtained successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Artist'
        "500":
          description: Server internal error.
    post:
      summary: Creates new artist.
      requestBody:
        description: Artist data to create.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtistInput'
      responses:
        "201":
          description: Artist created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artist'
        "400":
          description: Invalid data.
        "500":
          description: Server internal error.

  /artists/{id}:
    get:
      summary: Get artist by its ID.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Artist obtained successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artist'
        "404":
          description: Artist not found.
        "500":
          description: Server internal error.
    put:
      summary: Updates artists successfully.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        description: Updated artist data.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtistInput'
      responses:
        "200":
          description: Artist updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artist'
        "404":
          description: Artist not found.
        "500":
          description: Server internal error.
    delete:
      summary: Deletes an artist.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Artist deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Artist deleted successfully"
        "404":
          description: Artist not found
        "500":
          description: Server internal error.
  /merch:
    get:
      summary: Gets all available merchandise.
      responses:
        "200":
          description: Merchandise list retrieved successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Merchandise'
        "500":
          description: Server internal error.
    post:
      summary: Creates a new merchandise item.
      requestBody:
        description: Data of the item to create.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MerchandiseInput'
      responses:
        "201":
          description: Item created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Merchandise'
        "400":
          description: Invalid data.
        "500":
          description: Server internal error

  /merch/{id}:
    get:
      summary: Obtiene un artículo de merchandising por su ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Artículo obtenido exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Merchandise'
        "404":
          description: Artículo no encontrado
        "500":
          description: Error interno del servidor
    put:
      summary: Actualiza un artículo de merchandising existente
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        description: Datos actualizados del artículo
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MerchandiseInput'
      responses:
        "200":
          description: Artículo actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Merchandise'
        "404":
          description: Artículo no encontrado
        "500":
          description: Error interno del servidor
    delete:
      summary: Elimina un artículo de merchandising
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Artículo eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Merchandise deleted successfully"
        "404":
          description: Artículo no encontrado
        "500":
          description: Error interno del servidor

  /merch/artist/{artistId}:
    get:
      summary: Obtiene merchandising por artista
      parameters:
        - in: path
          name: artistId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Lista de merchandising del artista obtenida exitosamente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Merchandise'
        "404":
          description: Artista no encontrado
        "500":
          description: Error interno del servidor
  /cart:
    get:
      summary: Obtiene el contenido del carrito del usuario
      responses:
        "200":
          description: Contenido del carrito obtenido exitosamente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CartItem'
        "401":
          description: No autorizado
        "500":
          description: Error interno del servidor
    post:
      summary: Añade un ítem al carrito
      requestBody:
        description: Ítem a añadir al carrito
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CartItemInput'
      responses:
        "200":
          description: Ítem añadido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  cart:
                    type: array
                    items:
                      $ref: '#/components/schemas/CartItem'
        "400":
          description: Datos inválidos
        "401":
          description: No autorizado
        "500":
          description: Error interno del servidor
          
  /cart/{itemId}:
    delete:
      summary: Elimina un ítem del carrito
      parameters:
        - in: path
          name: itemId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Ítem eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  cart:
                    type: array
                    items:
                      $ref: '#/components/schemas/CartItem'
        "404":
          description: Ítem no encontrado
        "401":
          description: No autorizado
        "500":
          description: Error interno del servidor

  /payment:
    post:
      summary: Procesa un pago
      requestBody:
        description: Datos del pago a procesar
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                items:
                  type: array
                  items:
                    $ref: '#/components/schemas/CartItem'
                paymentInfo:
                  type: object
                  properties:
                    cardNumber:
                      type: string
                      example: "4242424242424242"
                    expiryDate:
                      type: string
                      example: "12/25"
                    cvc:
                      type: string
                      example: "123"
                shippingInfo:
                  type: object
                  properties:
                    name:
                      type: string
                      example: "Juan Pérez"
                    address:
                      type: string
                      example: "Calle Principal 123"
                    city:
                      type: string
                      example: "Madrid"
                    postalCode:
                      type: string
                      example: "28001"
                    country:
                      type: string
                      example: "España"
                    email:
                      type: string
                      example: "juan@example.com"
      responses:
        "200":
          description: Pago procesado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  orderId:
                    type: string
                    example: "ord_123456789"
                  receipt:
                    type: string
                    example: "https://example.com/receipt/ord_123456789"
        "400":
          description: Datos de pago inválidos
        "401":
          description: No autorizado
        "402":
          description: Pago rechazado
        "500":
          description: Error interno del servidor
  /payment/orders:
    get:
      summary: Obtiene el historial de órdenes del usuario
      responses:
        "200":
          description: Historial de órdenes obtenido exitosamente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'
        "401":
          description: No autorizado
        "500":
          description: Error interno del servidor
  /payment/orders/{orderId}:
    get:
      summary: Obtiene detalles de una orden específica
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Detalles de orden obtenidos exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        "404":
          description: Orden no encontrada
        "401":
          description: No autorizado
        "500":
          description: Error interno del servidor
components:
  schemas:
    Account:
      type: object
      properties:
        id:
          type: string
          example: 60d0fe4f5311236168a109ca
        username:
          type: string
          example: fanUser1
        email:
          type: string
          example: fan1@example.com
        role:
          type: string
          example: fan
        profileImage:
          type: string
          example: /assets/images/default-user.jpg
        bio:
          type: string
          example: Soy un fanático de la música.
        bandName:
          type: string
          example: The Rockers
        genre:
          type: string
          example: Rock
        labelName:
          type: string
          example: Super Records
        website:
          type: string
          example: https://superrecords.com    
    Album:
      type: object
      properties:
        _id:
          type: string
          example: "60d0fe4f5311236168a109cb"
        title:
          type: string
          example: "Álbum Debut"
        artistId:
          type: string
          example: "60d0fe4f5311236168a109cd"
        releaseYear:
          type: number
          example: 2023
        coverImage:
          type: string
          example: "/assets/images/album1.jpg"
        genre:
          type: string
          example: "Rock"
        price:
          type: number
          example: 9.99
        tracks:
          type: array
          items:
            $ref: '#/components/schemas/Track'
        ratings:
          type: array
          items:
            $ref: '#/components/schemas/Rating'
        vinyl:
          type: boolean
          example: true
        cd:
          type: boolean
          example: true
        cassettes:
          type: boolean
          example: false
        destacado:
          type: boolean
          example: false
    AlbumInput:
      type: object
      properties:
        title:
          type: string
          example: "Álbum Debut"
        artistId:
          type: string
          example: "60d0fe4f5311236168a109cd"
        releaseYear:
          type: number
          example: 2023
        coverImage:
          type: string
          example: "/assets/images/album1.jpg"
        genre:
          type: string
          example: "Rock"
        price:
          type: number
          example: 9.99
        tracks:
          type: array
          items:
            $ref: '#/components/schemas/TrackInput'
        vinyl:
          type: boolean
          example: true
        cd:
          type: boolean
          example: true
        cassettes:
          type: boolean
          example: false
        destacado:
          type: boolean
          example: false
      required:
        - title
        - artistId
        - releaseYear
        - genre
        - price
    Track:
      type: object
      properties:
        id:
          type: number
          example: 1
        title:
          type: string
          example: "Canción 1"
        duration:
          type: string
          example: "3:45"
        url:
          type: string
          example: "../music/song1.mp3"
        autor:
          type: string
          example: "Nombre del Artista"
        n_reproducciones:
          type: number
          example: 1500
    TrackInput:
      type: object
      properties:
        title:
          type: string
          example: "Canción 1"
        duration:
          type: string
          example: "3:45"
        url:
          type: string
          example: "../music/song1.mp3"
        autor:
          type: string
          example: "Nombre del Artista"
      required:
        - title
        - url
    Rating:
      type: object
      properties:
        userId:
          type: string
          example: "60d0fe4f5311236168a109ca"
        rating:
          type: number
          example: 4.5
        comment:
          type: string
          example: "Gran álbum, excelentes pistas"
        profileImage:
          type: string
          example: "/assets/images/avatar1.jpg"
    Artist:
      type: object
      properties:
        _id:
          type: string
          example: "60d0fe4f5311236168a109cd"
        id:
          type: number
          example: 1
        name:
          type: string
          example: "The Soundscapers"
        profileImage:
          type: string
          example: "/assets/images/artist1.jpg"
        genre:
          type: string
          example: "Rock"
        bio:
          type: string
          example: "Una banda de rock emergente conocida por sus actuaciones enérgicas."
        banner:
          type: string
          example: "/assets/images/banner1.jpg"
        seguidores:
          type: string
          example: "2.5M"
        ubicacion:
          type: string
          example: "Londres, RU"
        albums:
          type: array
          items:
            type: string
            example: "60d0fe4f5311236168a109cb"
        socialLinks:
          type: object
          properties:
            facebook:
              type: string
              example: "https://facebook.com/thesoundscapers"
            twitter:
              type: string
              example: "https://twitter.com/soundscapers"
            instagram:
              type: string
              example: "https://instagram.com/soundscapers"
    ArtistInput:
      type: object
      properties:
        name:
          type: string
          example: "The Soundscapers"
        profileImage:
          type: string
          example: "/assets/images/artist1.jpg"
        genre:
          type: string
          example: "Rock"
        bio:
          type: string
          example: "Una banda de rock emergente conocida por sus actuaciones enérgicas."
        banner:
          type: string
          example: "/assets/images/banner1.jpg"
        ubicacion:
          type: string
          example: "Londres, RU"
        socialLinks:
          type: object
          properties:
            facebook:
              type: string
              example: "https://facebook.com/thesoundscapers"
            twitter:
              type: string
              example: "https://twitter.com/soundscapers"
            instagram:
              type: string
              example: "https://instagram.com/soundscapers"
      required:
        - name
        - genre
    Merchandise:
      type: object
      properties:
        _id:
          type: string
          example: "60d0fe4f5311236168a109ce"
        id:
          type: number
          example: 1
        name:
          type: string
          example: "Camiseta de Banda"
        price:
          type: number
          example: 19.99
        image:
          type: string
          example: "/assets/images/merch1.jpg"
        description:
          type: string
          example: "Camiseta oficial de la banda, talla M"
        artistId:
          type: string
          example: "60d0fe4f5311236168a109cd"
        type:
          type: number
          example: 3
          description: "0: vinyl, 1: cd, 2: cassette, 3: camiseta"
        stock:
          type: number
          example: 50
    MerchandiseInput:
      type: object
      properties:
        name:
          type: string
          example: "Camiseta de Banda"
        price:
          type: number
          example: 19.99
        image:
          type: string
          example: "/assets/images/merch1.jpg"
        description:
          type: string
          example: "Camiseta oficial de la banda, talla M"
        artistId:
          type: string
          example: "60d0fe4f5311236168a109cd"
        type:
          type: number
          example: 3
          description: "0: vinyl, 1: cd, 2: cassette, 3: camiseta"
        stock:
          type: number
          example: 50
      required:
        - name
        - price
        - image
        - description
        - type
    CartItem:
      type: object
      properties:
        _id:
          type: string
          example: "60d0fe4f5311236168a109cf"
        userId:
          type: string
          example: "60d0fe4f5311236168a109ca"
        itemId:
          type: string
          example: "60d0fe4f5311236168a109ce"
        itemType:
          type: string
          enum: [merchandise, album, track]
          example: "merchandise"
        name:
          type: string
          example: "Camiseta de Banda"
        price:
          type: number
          example: 19.99
        quantity:
          type: number
          example: 1
        image:
          type: string
          example: "/assets/images/merch1.jpg"
    CartItemInput:
      type: object
      properties:
        itemId:
          type: string
          example: "60d0fe4f5311236168a109ce"
        itemType:
          type: string
          enum: [merchandise, album, track]
          example: "merchandise"
        quantity:
          type: number
          example: 1
      required:
        - itemId
        - itemType
        - quantity
    Order:
      type: object
      properties:
        _id:
          type: string
          example: "60d0fe4f5311236168a109d0"
        userId:
          type: string
          example: "60d0fe4f5311236168a109ca"
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        total:
          type: number
          example: 29.99
        status:
          type: string
          enum: [pending, processing, completed, failed]
          example: "completed"
        shippingInfo:
          type: object
          properties:
            name:
              type: string
              example: "Juan Pérez"
            address:
              type: string
              example: "Calle Principal 123"
            city:
              type: string
              example: "Madrid"
            postalCode:
              type: string
              example: "28001"
            country:
              type: string
              example: "España"
            email:
              type: string
              example: "juan@example.com"
            phone:
              type: string
              example: "612345678"
        paymentInfo:
          type: object
          properties:
            method:
              type: string
              enum: [card, paypal]
              example: "card"
            transactionId:
              type: string
              example: "tx_123456789"
            lastFourDigits:
              type: string
              example: "4242"
        createdAt:
          type: string
          format: date-time
          example: "2023-10-15T14:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2023-10-15T14:35:00Z"
